---
title: "Coverage analysis of cttso data"
author: "Sehrish Kanwal"
date: "`r format(Sys.time(), '%a %Y-%b-%d')`"
output:
  html_document:
    keep_md: yes
    css: style.css
    theme: readable
    toc: true
    toc_float: true
    code_folding: hide
  rmdformats::material:
    highlight: kate
params:
  mosdepth_output: '/Users/kanwals/UMCCR/data/projects/cttso-qc/mosdepth_output_tst500c'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
### Required packages.
library(here)
library(dplyr)
library(tidyverse)
library(stringr)
library(DT)
library(jtools)
```

***

## Introduction

In this analysis, we are looking at the coverage of panel target regions across our tso cohort.

## Data

The TSO500 alignment files used for calculating coverage exist in GDS. The script used to run [mosdepth tool](https://github.com/brentp/mosdepth) on these bams for ~280 samples can be found [here](./scripts/run_cttso_bams_through_mosdepth.sh)

mosdepth can output the mean per-region given a BED file of regions. The result is summarised in the table below:


```{r raw_cov_results, message=FALSE, warning=FALSE}
# read in bed file with regions of interest
bed <- as.data.frame(read.table("/Users/kanwals/UMCCR/data/projects/cttso-qc/TST500C_manifest.bed", header = FALSE, sep="\t", stringsAsFactors=FALSE))
colnames(bed) <- c("chr", "region_start", "region_end", "name")

# list files in the input directory - made using mosdepth
list_of_files <- list.files(path = params$mosdepth_output,
                            recursive = TRUE,
                            pattern = "\\.bed.gz$",
                            full.names = TRUE)

for (i in 1:length(list_of_files)){
  # read files and prepare data format for display
  file <- read_tsv(list_of_files[i],col_names = c("chr", "region_start", "region_end", "name", "mean_coverage" ),col_types = "cn") %>%
      mutate(sample_id = basename(list_of_files[i])) %>%
      mutate(sample_id = gsub("*.regions.bed.gz", "", sample_id)) 
  # find sample id and rename mean_coverage column using it
  sample_name <- unique(file$sample_id)
  sample_coverage <- file %>%
    dplyr::rename(!!sample_name := mean_coverage) %>%
    dplyr::select(one_of(sample_name))
  # add sample_coverage to original bed file
  bed <- cbind(bed, sample_coverage) 
    
}

# display input data in a table
datatable(df, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T), caption = "Mean coverage of TERT promoter region and region of interest")
```

## Coverage plot

The mean coverage ratio for the cttso500 samples can be found in the table below.

Also, it's recommended to view the coverage plot on a bigger screen, as the number of samples and data points is large. 

```{r prepare_data, message=FALSE, warning=FALSE, results='hide'}
#read input
coverage_beds <-list.files(params$mosdepth_output,
           full.names = T)

dat <- data.frame(matrix(ncol = 2, nrow = 0))
colnames(dat) = c("sample", "mean_coverage_ratio")
file <- data.frame()

for (i in 1:length(coverage_beds)){
  print(coverage_beds[i])
  file <- read.table(coverage_beds[i],col.names = c("chr", "region_start", "region_end", "mean_coverage" )) %>%
    mutate(sample_name = basename(coverage_beds[i])) %>%
    mutate(sample_name = gsub(".regions.bed.gz", "", sample_name)) %>%
    mutate(ratio = mean_coverage[1] / mean_coverage[2]) %>%
    distinct(.keep_all = FALSE)


  sample_name = unique(file$sample_name)
  ratio_mean_cov = unique(file$ratio)

  dat[nrow(dat) + 1, ] <- c(sample_name, round(ratio_mean_cov, 2))
}

# sort ratio
dat <- dat[order(dat$mean_coverage_ratio),]
# convert ratio values to numeric and omit nan values
dat$mean_coverage_ratio <- as.numeric(as.character(dat$mean_coverage_ratio))
dat <- na.omit(dat)

```

``` {r coverage_plot, message=FALSE, warning=FALSE,}
# display data in a table
datatable(dat, rownames = FALSE, filter="top", options = list(pageLength = 5, scrollX=T), caption = "Ratio of mean coverage of TERT promoter region and region of interest")

# plot results https://r-graph-gallery.com/267-reorder-a-variable-in-ggplot2.html
#dat %>%
#  arrange(mean_coverage_ratio) %>%
#  mutate(sample=factor(sample, levels=sample)) %>% # This trick update the factor levels
#  ggplot( aes(x=mean_coverage_ratio, y=sample)) +
#  geom_segment( aes(xend=0, yend=sample)) +
#  geom_point( size=4, color="orange") +
#  coord_flip() +
#  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
#  xlab("coverage_ratio")

means <- aggregate(mean_coverage ~  group, df_regions_combined, mean)
means$mean_coverage = round(means$mean_coverage, 2)

df_regions_combined %>%
  ggplot( aes(y=mean_coverage, x=group, fill=group)) +
  geom_boxplot(alpha=0.7) +
  geom_text(data = means, aes(label = mean_coverage, y = mean_coverage + 0.09))

dat %>%
  arrange(mean_coverage_ratio) %>%
  mutate(sample=factor(sample, levels=sample)) %>% # This trick update the factor levels
  ggplot( aes(x=sample, y=mean_coverage_ratio)) +
    geom_point( size=1.5, color="orange") +
    theme(axis.title.x=element_text(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())

# plot results - violin plot
dat %>%
  ggplot( aes(y=mean_coverage_ratio, x="sample")) +
  geom_violin(trim=FALSE, fill="grey") + 
  geom_dotplot(binaxis= "y",
               stackdir = "center",
               dotsize = 0.5,
               fill = 1) +
  theme_apa()

# plot results - violin plot
dat %>%
  ggplot( aes(y=mean_coverage_ratio, x="sample")) +
  geom_violin(trim=FALSE, fill="grey") + 
  geom_boxplot(width=0.1) +
  theme_apa()

dat %>%
  ggplot(aes(x = mean_coverage_ratio)) +
  geom_histogram(binwidth = 0.01, color = "orange") +
  geom_boxplot(width=0.1) + theme_apa()

```
